<!DOCTYPE html>
<html>
<head>
  <title>Grid World</title>
  <style>
    .grid-container {
      display: grid;
      grid-template-columns: repeat({{ size }}, minmax(0, 1fr)); /* Ensures cells do not grow beyond the size set by max-width of the container */
      gap: 10px;
      max-width: 500px; /* Maximum width of the grid */
      margin: auto; /* Centers the grid horizontally */
      padding: 20px; /* Adds space around the grid */
    }
    .grid-cell {
      border: 1px solid black;
      aspect-ratio: 1 / 1; /* Keeps cells square */
      display: flex;
      align-items: center;
      justify-content: center;
      background-color: white; /* Default road color */
    }
    .start { background-color: green; }
    .end { background-color: blue; }
    .obstacle { background-color: grey; }
    .penalty { background-color: red; }
  </style>
  
  
  
</head>
<body>
  <h1>Grid World</h1>
  <div class="grid-container">
    {% for i in range(size * size) %}
      <div class="grid-cell" id="cell-{{ i }}" onclick="changeState(this)"></div>
    {% endfor %}
  </div>

  <div id="message"></div>
  <button onclick="validateGrid()">Check Grid</button>
  

  <script>
    function changeState(cell) {
      const classes = ["start", "end", "obstacle", "penalty", "road"];
      let currentClass = cell.className.split(' ').find(cls => classes.includes(cls));
      let currentIndex = classes.indexOf(currentClass);
      let nextStateIndex = (currentIndex + 1) % classes.length;
  
      // Remove the current class if it exists
      if (currentClass) {
        cell.classList.remove(currentClass);
      }
  
      // Add the next class
      cell.classList.add(classes[nextStateIndex]);
    }
  
  </script>
  <script>
    function validateGrid() {
      const maxObstacles = {{ size }} - 2;  // Maximum allowed obstacles
      let starts = document.querySelectorAll('.start').length;
      let ends = document.querySelectorAll('.end').length;
      let obstacles = document.querySelectorAll('.obstacle').length;
      let message = "";
    
      if (starts !== 1 || ends !== 1) {
        message = "There must be exactly one starting cell and one ending cell. ";
      }
    
      if (obstacles > maxObstacles) {
        message += "At most " + maxObstacles + " obstacle(s) allowed.";
      }
    
      if (message === "") {
        message = "Grid is valid!";
        const cells = document.querySelectorAll('.grid-cell');
        const states = Array.from(cells).map(cell => {
          const stateClass = cell.classList.value.split(' ').find(cls => cls === 'start' || cls === 'end' || cls === 'obstacle' || cls === 'penalty' || cls === 'road');
          return stateClass || 'road';  // 使用 'road' 作为默认状态
        });
    
        console.log(states);  // 打印 states 陣列到控制台
    
        // 发送 AJAX 请求到服务器
        fetch('/validate_grid', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({states: states})
        })
        .then(response => {
          if (!response.ok) {
            throw new Error('Network response was not ok');
          }
          return response.json();
        })
        .then(data => {
          console.log(data.message);  // 从服务器返回的消息
          document.getElementById('message').textContent = data.message; // 显示服务器返回的消息
        })
        .catch(error => {
          console.error('Error:', error);
          document.getElementById('message').textContent = 'An error occurred';
        });
      } else {
        document.getElementById('message').textContent = message;
      }
    }
    
  </script>
  
  
</html>
